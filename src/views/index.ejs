<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ronny's Car Wash - Chemical Inventory</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <header>
      <div class="header-content">
        <% if (typeof hasOpenRequest !== 'undefined' && hasOpenRequest) { %>
          <div class="pickup-notification" onclick="openFulfillModal()" title="Pickup Requested">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 3h15v13H1zM16 8h4l3 3v5h-7V8z"/>
              <circle cx="5.5" cy="18.5" r="2.5"/>
              <circle cx="18.5" cy="18.5" r="2.5"/>
            </svg>
            <span>Pickup Requested</span>
          </div>
        <% } %>
        <h1>Ronny's Car Wash</h1>
      </div>
      <h2>Chemical Inventory</h2>
    </header>
    <main>
<!-- Current Inventory Tally Box -->
<div class="tally-box" onclick="openInventoryModal()">
  <% if (typeof hasLowInventory !== 'undefined' && hasLowInventory) { %>
    <div class="low-inventory-banner">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
        <line x1="12" y1="9" x2="12" y2="13"/>
        <line x1="12" y1="17" x2="12.01" y2="17"/>
      </svg>
      <span class="low-inventory-text">Low Inventory Alert</span>
      <span class="low-inventory-count"><%= lowInventoryItems.length %> item<%= lowInventoryItems.length !== 1 ? 's' : '' %></span>
    </div>
  <% } %>
  <div class="tally-main">
    <div class="tally-label">Current Inventory</div>
    <div class="inventory-updated">Last updated: <%= typeof lastUpdatedFormatted !== 'undefined' ? lastUpdatedFormatted : '—' %></div>
    <div class="tally-value"><%= totals.totalGallons %> Gallons</div>
  </div>
  <div class="tally-details">
    <span><%= totals.totalBoxes %> Boxes</span>
    <span><%= totals.totalBarrels %> Barrels</span>
    <span><%= totals.totalBuckets %> Buckets</span>
  </div>
  <div class="tally-hint">Click to view breakdown</div>
</div>

<!-- Action Buttons -->
<div class="action-buttons">
  <button class="btn btn-primary" onclick="openPickupModal()">Pick up chemicals</button>
  <button class="btn btn-primary" onclick="openRequestModal()">Request chemicals</button>
  <button class="btn btn-primary" onclick="openUpdateModal()">Update inventory</button>
</div>

<!-- Activity Log -->
<div class="activity-log">
  <h3>Activity Log</h3>
  <ul class="log-list">
    <% if (activityLogs.length === 0) { %>
      <li class="log-entry empty">No activity yet</li>
    <% } else { %>
      <% activityLogs.forEach(log => { %>
        <li class="log-entry clickable" onclick="openLogDetailModal('<%= log.id %>')">
          <%= log.message %>
          <% if (log.note) { %>
            <span class="log-note"> - <%= log.note %></span>
          <% } %>
        </li>
      <% }); %>
    <% } %>
  </ul>
</div>

<!-- Inventory Breakdown Modal -->
<div id="inventoryModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Inventory Breakdown</h2>
      <span class="close" onclick="closeModal('inventoryModal')">&times;</span>
    </div>
    <div class="modal-body">
      <% if (typeof hasLowInventory !== 'undefined' && hasLowInventory) { %>
        <div class="low-inventory-section">
          <h3 class="low-inventory-heading">⚠️ Low Inventory Items</h3>
          <ul class="low-inventory-list">
            <% lowInventoryItems.forEach(item => { %>
              <li class="low-inventory-item">
                <span class="low-item-name"><%= item.chemicalName %></span>
                <span class="low-item-details">
                  <%= item.currentDisplay %> on the <%= item.location === 'SHELF' ? 'Shelf' : 'Line' %>
                  (threshold: <%= item.threshold %> <%= item.unit.toLowerCase() + (item.threshold !== 1 ? (item.unit === 'BOX' ? 'es' : 's') : '') %>)
                </span>
              </li>
            <% }); %>
          </ul>
        </div>
      <% } %>
      <table class="inventory-table">
        <thead>
          <tr>
            <th>Chemical</th>
            <th>On the Shelf</th>
            <th>On the Line</th>
            <th>Combined</th>
          </tr>
        </thead>
        <tbody>
          <% chemicals.forEach((chemical, index) => { %>
            <tr>
              <td><%= chemical.name %></td>
              <td><%= chemical.shelfQtyDisplay %></td>
              <td><%= chemical.lineQtyDisplay %></td>
              <td><strong><%= chemical.combinedQtyDisplay %></strong></td>
            </tr>
            <% 
              // Add separator after: Prizm Gold, RLC, Air Freshener - Cool Water
              const separatorAfter = ['Prizm Gold', 'RLC', 'Air Freshener - Cool Water'];
              if (separatorAfter.includes(chemical.name) && index < chemicals.length - 1) {
            %>
            <tr class="separator-row">
              <td colspan="4"><div class="table-separator"></div></td>
            </tr>
            <% } %>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Pickup Modal -->
<div id="pickupModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Pick up chemicals</h2>
      <span class="close" onclick="closeModal('pickupModal')">&times;</span>
    </div>
    <div class="modal-body">
      <form id="pickupForm" action="/pickup" method="POST">
        <div class="chemical-list">
          <% chemicals.forEach((chemical, index) => { %>
            <% 
              // Add separator after: Prizm Gold, RLC, Air Freshener - Cool Water
              const separatorAfter = ['Prizm Gold', 'RLC', 'Air Freshener - Cool Water'];
              if (separatorAfter.includes(chemical.name) && index < chemicals.length - 1) {
            %>
            <div class="chemical-separator"></div>
            <% } %>
            <div class="chemical-item" data-chemical-id="<%= chemical.id %>">
              <div class="chemical-name"><%= chemical.name %></div>
              <% if (chemical.trackOnShelf || chemical.trackOnLine) { %>
                <!-- Pickup always goes to shelf - hidden input -->
                <input type="hidden" name="pickups[<%= chemical.id %>][location]" value="SHELF">
                <div class="chemical-inputs single-input">
                  <div class="form-group">
                    <label>Quantity</label>
                    <select 
                      class="pickup-qty" 
                      name="pickups[<%= chemical.id %>][qty]"
                      data-chemical-id="<%= chemical.id %>"
                    >
                      <option value="">--</option>
                      <% 
                        // Pickup always uses whole quantities (1.0 increment), skip 0
                        const pickupQtyOptions = generateQuantityOptions(1.0, 50, true);
                      %>
                      <% pickupQtyOptions.forEach(qty => { %>
                        <option value="<%= qty %>"><%= qty %></option>
                      <% }); %>
                    </select>
                  </div>
                </div>
              <% } else { %>
                <div class="chemical-inputs">
                  <div class="no-tracking">Not tracked</div>
                </div>
              <% } %>
            </div>
          <% }); %>
        </div>
        <div class="form-group" id="pickupNoteGroup" style="display: none;">
          <label for="pickupNote">Note (optional)</label>
          <input type="text" id="pickupNote" name="note">
        </div>
        <div class="form-actions">
          <button type="button" class="btn-icon" onclick="toggleNoteField('pickupNoteGroup')" title="Add note">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
          </button>
          <div class="form-actions-buttons">
            <button type="button" class="btn btn-secondary" onclick="closeModal('pickupModal')">Cancel</button>
            <button type="submit" class="btn btn-primary">Submit</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Request Modal -->
<div id="requestModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Request chemicals</h2>
      <span class="close" onclick="closeModal('requestModal')">&times;</span>
    </div>
    <div class="modal-body">
      <form id="requestForm" action="/request" method="POST">
        <div class="chemical-list">
          <% chemicals.forEach((chemical, index) => { %>
            <% 
              // Add separator after: Prizm Gold, RLC, Air Freshener - Cool Water
              const separatorAfter = ['Prizm Gold', 'RLC', 'Air Freshener - Cool Water'];
              if (separatorAfter.includes(chemical.name) && index < chemicals.length - 1) {
            %>
            <div class="chemical-separator"></div>
            <% } %>
            <div class="chemical-item" data-chemical-id="<%= chemical.id %>">
              <div class="chemical-name"><%= chemical.name %></div>
              <div class="chemical-inputs">
                <div class="form-group">
                  <label>Quantity (optional)</label>
                  <select
                    class="request-qty"
                    name="qty"
                    data-chemical-id="<%= chemical.id %>"
                    data-unit="<%= chemical.unit %>"
                    data-increment="1.0"
                  >
                    <option value="0">--</option>
                    <% 
                      // Request uses whole numbers only (1.0 increment)
                      const requestQtyOptions = generateQuantityOptions(1.0, 50, true);
                    %>
                    <% requestQtyOptions.forEach(qty => { %>
                      <option value="<%= qty %>"><%= qty %></option>
                    <% }); %>
                  </select>
                </div>
              </div>
            </div>
          <% }); %>
        </div>
        <div class="form-group" id="requestNoteGroup" style="display: none;">
          <label for="requestNote">Note (optional)</label>
          <input type="text" id="requestNote" name="note">
        </div>
        <div class="form-actions">
          <button type="button" class="btn-icon" onclick="toggleNoteField('requestNoteGroup')" title="Add note">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
          </button>
          <div class="form-actions-buttons">
            <button type="button" class="btn btn-secondary" onclick="closeModal('requestModal')">Cancel</button>
            <button type="submit" class="btn btn-primary">Submit</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Update Modal -->
<div id="updateModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Update inventory</h2>
      <span class="close" onclick="closeModal('updateModal')">&times;</span>
    </div>
    <div class="modal-body">
      <form id="updateForm" action="/update" method="POST">
        <input type="hidden" id="updateLocation" name="location" value="SHELF">
        
        <!-- Tabs -->
        <div class="tabs">
          <button type="button" class="tab-button active" data-location="SHELF" onclick="switchUpdateTab('SHELF')">On the Shelf</button>
          <button type="button" class="tab-button" data-location="LINE" onclick="switchUpdateTab('LINE')">On the Line</button>
        </div>

        <div class="chemical-list" id="updateChemicalList">
          <!-- Chemicals will be populated by JS based on selected tab -->
        </div>
        <div class="form-group" id="updateNoteGroup" style="display: none;">
          <label for="updateNote">Note (optional)</label>
          <input type="text" id="updateNote" name="note">
        </div>
        <div class="form-actions">
          <button type="button" class="btn-icon" onclick="toggleNoteField('updateNoteGroup')" title="Add note">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
          </button>
          <div class="form-actions-buttons">
            <button type="button" class="btn btn-secondary" onclick="closeModal('updateModal')">Cancel</button>
            <button type="submit" class="btn btn-primary">Submit</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Fulfill Request Modal -->
<div id="fulfillModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Fulfill Request</h2>
      <span class="close" onclick="closeModal('fulfillModal')">&times;</span>
    </div>
    <div class="modal-body">
      <div id="fulfillContent">
        <p>Loading request details...</p>
      </div>
    </div>
  </div>
</div>

<!-- Log Detail Modal -->
<div id="logDetailModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Activity Log Details</h2>
      <span class="close" onclick="closeModal('logDetailModal')">&times;</span>
    </div>
    <div class="modal-body">
      <div id="logDetailContent">
        <p>Loading details...</p>
      </div>
    </div>
  </div>
</div>

<script>
  // Make chemicals data available to JS
  window.chemicalsData = <%- JSON.stringify(chemicals) %>;
  window.hasOpenRequest = <%- typeof hasOpenRequest !== 'undefined' && hasOpenRequest ? 'true' : 'false' %>;
  window.openRequestBatchId = <%- typeof openRequestBatchId !== 'undefined' && openRequestBatchId ? JSON.stringify(openRequestBatchId) : 'null' %>;
</script>
    </main>
    <% if (typeof sheetsEnabled !== 'undefined' && sheetsEnabled) { %>
      <footer style="text-align: center; padding: 20px; color: #888; font-size: 14px; border-top: 1px solid #444; margin-top: 30px;">
        <span style="color: #4caf50;">●</span> Sheets: Connected
      </footer>
    <% } %>
  </div>
  <script src="/app.js"></script>
</body>
</html>

